# Wirebox

Lightweight PHP 8.4 DI container with autowiring, directory scanning, PHP attributes, and dotenv support.

## Features

- **PSR-11** compatible (`Psr\Container\ContainerInterface`)
- **Autowiring** — automatic constructor dependency resolution via reflection
- **Directory scanning** — point at a directory, all classes are auto-registered
- **PHP Attributes** — `#[Inject]`, `#[Singleton]`, `#[Transient]`, `#[Tag]`, `#[Param]`, `#[Exclude]`
- **Dotenv** — built-in `.env` parser with 3-level priority (no external dependencies)
- **Tagged services** — group services by tag and retrieve them as a collection
- **Compiled container** — generate a PHP class with zero reflection at runtime
- **Setter injection** — configure method calls on services after instantiation
- **Circular dependency detection** — clear error messages with the full dependency chain

## Requirements

- PHP >= 8.4
- [psr/container](https://packagist.org/packages/psr/container) ^2.0

## Installation

```bash
composer require ascetic-soft/wirebox
```

## Quick Start

```php
use AsceticSoft\Wirebox\ContainerBuilder;

$builder = new ContainerBuilder(projectDir: __DIR__);

// Scan a directory — all concrete classes are auto-registered
$builder->scan(__DIR__ . '/src');

// Build the container
$container = $builder->build();

// Resolve any service
$service = $container->get(App\UserService::class);
```

## Configuration

### ContainerBuilder

The `ContainerBuilder` is the main entry point for configuring the container.

```php
$builder = new ContainerBuilder(projectDir: __DIR__);
```

The `projectDir` is used as the base path for resolving `.env` files.

### Directory Scanning

Scan directories to auto-register all concrete classes (abstract classes, interfaces, traits, and enums are skipped):

```php
$builder->scan(__DIR__ . '/src');
$builder->scan(__DIR__ . '/modules');
```

Exclude files by glob pattern:

```php
$builder->exclude('Entity/*');
$builder->exclude('*Test.php');
$builder->scan(__DIR__ . '/src');
```

Classes marked with `#[Exclude]` are skipped automatically:

```php
use AsceticSoft\Wirebox\Attribute\Exclude;

#[Exclude]
class InternalHelper
{
    // Will not be registered in the container
}
```

### Interface Binding

Bind an interface to a concrete implementation:

```php
$builder->bind(LoggerInterface::class, FileLogger::class);
```

When scanning, if an interface has exactly one implementation in the scanned directory, it is auto-bound.

### Factory Registration

Register a service with a custom factory closure:

```php
$builder->register(Connection::class, function (Container $c) {
    return new Connection(
        host: $c->getParameter('db.host'),
        port: $c->getParameter('db.port'),
    );
});
```

### Fluent Definition API

Override or configure individual service definitions:

```php
$builder->register(FileLogger::class)
    ->transient()                                   // New instance every time
    ->tag('logger')                                 // Add a tag
    ->call('setFormatter', [JsonFormatter::class]);  // Setter injection
```

### Parameters and Environment Variables

Set parameters that can reference environment variables:

```php
$builder->parameter('db.host', '%env(DB_HOST)%');
$builder->parameter('db.port', '%env(int:DB_PORT)%');
$builder->parameter('app.debug', '%env(bool:APP_DEBUG)%');
$builder->parameter('rate.limit', '%env(float:RATE_LIMIT)%');
```

Supported type casts: `string` (default), `int`, `float`, `bool`.

Parameters can also contain env expressions embedded in a larger string:

```php
$builder->parameter('dsn', 'mysql:host=%env(DB_HOST)%;port=%env(DB_PORT)%');
```

## Environment Variables

Wirebox resolves environment variables with 3-level priority (highest first):

| Priority | Source               | Description                                                               |
|----------|----------------------|---------------------------------------------------------------------------|
| 1        | `.env.local.php`     | Generated by `composer dump-env`. A PHP file returning an array. Fastest. |
| 2        | `$_ENV` / `getenv()` | Real system environment variables.                                        |
| 3        | `.env`               | Parsed by built-in `DotEnvParser`. Development fallback.                  |

All files are resolved relative to `projectDir`.

### `.env` File Format

```env
APP_NAME=Wirebox
DB_HOST=localhost
DB_PORT=5432
APP_DEBUG=true

# Comments are supported
QUOTED="hello world"
SINGLE='literal value'

# Variable interpolation
BASE_PATH=/opt
FULL_PATH="${BASE_PATH}/app"

# Export prefix is stripped
export SECRET_KEY=abc123
```

### Production: `composer dump-env`

For production, use Symfony's `composer dump-env` to generate `.env.local.php`:

```bash
composer dump-env prod
```

This creates a PHP file that returns an array — no file parsing at runtime.

## PHP Attributes

### `#[Singleton]`

Marks a class as singleton (this is the default behavior, use for explicitness):

```php
use AsceticSoft\Wirebox\Attribute\Singleton;

#[Singleton]
class DatabaseConnection
{
}
```

### `#[Transient]`

A new instance is created on every `get()` call:

```php
use AsceticSoft\Wirebox\Attribute\Transient;

#[Transient]
class RequestContext
{
}
```

### `#[Tag]`

Tag a class for grouped retrieval. Repeatable:

```php
use AsceticSoft\Wirebox\Attribute\Tag;

#[Tag('event.listener')]
#[Tag('audit')]
class UserCreatedListener
{
}
```

Retrieve tagged services:

```php
foreach ($container->getTagged('event.listener') as $listener) {
    $listener->handle($event);
}
```

### `#[Inject]`

Specify a concrete implementation for a type-hinted parameter:

```php
use AsceticSoft\Wirebox\Attribute\Inject;

class NotificationService
{
    public function __construct(
        #[Inject(SmtpMailer::class)]
        private MailerInterface $mailer,
    ) {
    }
}
```

### `#[Param]`

Inject a scalar value from environment variables:

```php
use AsceticSoft\Wirebox\Attribute\Param;

class DatabaseService
{
    public function __construct(
        #[Param('DB_HOST')] private string $host,
        #[Param('DB_PORT')] private int $port,
        #[Param('APP_DEBUG')] private bool $debug = false,
    ) {
    }
}
```

The value is automatically cast to the parameter's type hint (`string`, `int`, `float`, `bool`).

### `#[Exclude]`

Exclude a class from auto-registration during directory scanning:

```php
use AsceticSoft\Wirebox\Attribute\Exclude;

#[Exclude]
class InternalHelper
{
}
```

## Container API

### PSR-11

```php
$service = $container->get(UserService::class);
$exists  = $container->has(UserService::class);
```

### Tagged Services

```php
$loggers = $container->getTagged('logger'); // iterable<object>
```

### Parameters

```php
$host = $container->getParameter('db.host');
$all  = $container->getParameters();
```

### Self-Resolution

The container registers itself, so you can type-hint it:

```php
use Psr\Container\ContainerInterface;

class ServiceLocator
{
    public function __construct(
        private ContainerInterface $container,
    ) {
    }
}
```

## Compiled Container

For production, compile the container to a PHP class. This eliminates reflection at runtime:

```php
$builder = new ContainerBuilder(projectDir: __DIR__);
$builder->scan(__DIR__ . '/src');
$builder->bind(LoggerInterface::class, FileLogger::class);
$builder->parameter('db.host', '%env(DB_HOST)%');

// Generate the compiled container
$builder->compile(
    outputPath: __DIR__ . '/var/cache/CompiledContainer.php',
    className: 'CompiledContainer',
    namespace: 'App\Cache',
);
```

Use the compiled container in production:

```php
require_once __DIR__ . '/var/cache/CompiledContainer.php';

$container = new App\Cache\CompiledContainer();
$service = $container->get(UserService::class);
```

The compiled container:
- Extends `AsceticSoft\Wirebox\Compiler\CompiledContainer`
- Implements `Psr\Container\ContainerInterface`
- Has a dedicated factory method for each service
- Supports singleton caching, bindings, parameters, and tags
- Does **not** support factory closures (they require runtime evaluation)

## Error Handling

Wirebox throws specific exceptions for common issues:

| Exception                     | When                                       |
|-------------------------------|--------------------------------------------|
| `NotFoundException`           | Service not found and cannot be auto-wired |
| `AutowireException`           | Cannot resolve a constructor parameter     |
| `CircularDependencyException` | A -> B -> A circular dependency detected   |
| `ContainerException`          | General container error                    |

All exceptions implement `Psr\Container\ContainerExceptionInterface`.

```php
use AsceticSoft\Wirebox\Exception\CircularDependencyException;

try {
    $container->get(ServiceA::class);
} catch (CircularDependencyException $e) {
    // "Circular dependency detected: ServiceA -> ServiceB -> ServiceA"
    echo $e->getMessage();
}
```

## Full Example

```php
// bootstrap.php
use AsceticSoft\Wirebox\ContainerBuilder;

$builder = new ContainerBuilder(projectDir: __DIR__);

// Exclude entities and migrations from the container
$builder->exclude('Entity/*');
$builder->exclude('Migration/*');

// Scan application classes
$builder->scan(__DIR__ . '/src');

// Explicit bindings where needed
$builder->bind(LoggerInterface::class, FileLogger::class);
$builder->bind(CacheInterface::class, RedisCache::class);

// Environment-based parameters
$builder->parameter('db.host', '%env(DB_HOST)%');
$builder->parameter('db.port', '%env(int:DB_PORT)%');
$builder->parameter('app.debug', '%env(bool:APP_DEBUG)%');

// Custom factory
$builder->register(PDO::class, function ($c) {
    return new PDO(
        sprintf('mysql:host=%s;port=%d;dbname=app', 
            $c->getParameter('db.host'),
            $c->getParameter('db.port'),
        ),
    );
});

// Build and use
$container = $builder->build();
$app = $container->get(App\Kernel::class);
$app->run();
```

## Testing

```bash
composer install
vendor/bin/phpunit
```

## License

MIT
